{{ define "layout" }}
  <!DOCTYPE html>
  <html lang="en">
    <head>
      <title>
        {{ .title }}
      </title>

      <link rel="stylesheet" href="/ui/assets/vendor/css/bootstrap.min.css">
      <link rel="stylesheet" href="/ui/assets/vendor/css/bootstrap-theme.min.css">
      <link rel="stylesheet" href="/ui/assets/css/main.css">
      <script src="/ui/assets/vendor/js/jquery-3.1.0.min.js"></script>
      <script src="/ui/assets/vendor/js/bootstrap.min.js"></script>

      <style>
        html {
          height: 100%;
        }

        body {
          height: 100%
        }

        .navbar-default {
          margin-bottom: 0;
        }

        .navbar-default .navbar-brand {
          color: #444;
          font-family: 'Doppio One', sans-serif;
        }

        .container-fluid#main {
          height: 100%;
          /* We do this cuz navbar causes unnecessary scroll with height 100% on subsequent elements */
          margin-top: -52px;
          padding-top: 52px;
        }

        .row#main {
          height: 100%;
        }

        #content {
          padding-top: 20px;
          height: 100%;
        }

        .row#main_row {
          height: 100%;
          overflow-y: scroll;
        }

        .row.above_log {
          margin-bottom: -200px;
          padding-bottom: 200px;
        }

        div#log {
          /* height must match margin-bottom of #main_row */
          background: #222;
          color: #999;
          white-space: pre-wrap;
          height: 200px;
          margin: 0 -15px 0 -15px;
          padding: 0 0 0 15px;
          overflow-y: scroll;
          font-family: Consolas, Menlo, Courier, monospace;
        }

        #sidenav {
          height: 100%;
          padding: 0;
        }

        #sidenav .list-group {
          height: 100%;
          background: #333;
          border-radius: 0;
          margin: 0;
        }

        #sidenav .list-group-item {
          color: #ddd;
          background: #333;
          border: none;
          font-size: 14px;
          font-family: 'Doppio One', sans-serif;
          padding: 15px 0 15px 17px;
          border-radius: 0;
        }

        #sidenav .list-group-item:focus, #sidenav .list-group-item:hover {
          color: #eee;
          background-color: #444;
        }

        #sidenav .list-group-item.active, #sidenav .list-group-item.active:focus, #sidenav .list-group-item.active:hover {
          color: #fff;
          background-color: cornflowerblue;
        }

        .disabled {
          opacity: 0.5;
          pointer-events: none;
        }

        td.item_selector, td.item_selector > input {
          cursor: pointer;
        }

        textarea.form-control {
          font-family: Menlo,Monaco,Consolas,"Courier New",monospace;
          font-size: 13px;
          background: aliceblue;
        }


        /* Loader */
        #circleG{
          width:34px;
          margin:auto;
          display: inline-block;
          float: right;
          padding-top: 7px;
        }

        .circleG{
          background-color:rgb(255,255,255);
          float:left;
          height:7px;
          margin-left:4px;
          width:7px;
          animation-name:bounce_circleG;
          -o-animation-name:bounce_circleG;
          -ms-animation-name:bounce_circleG;
          -webkit-animation-name:bounce_circleG;
          -moz-animation-name:bounce_circleG;
          animation-duration:1.3675s;
          -o-animation-duration:1.3675s;
          -ms-animation-duration:1.3675s;
          -webkit-animation-duration:1.3675s;
          -moz-animation-duration:1.3675s;
          animation-iteration-count:infinite;
          -o-animation-iteration-count:infinite;
          -ms-animation-iteration-count:infinite;
          -webkit-animation-iteration-count:infinite;
          -moz-animation-iteration-count:infinite;
          animation-direction:normal;
          -o-animation-direction:normal;
          -ms-animation-direction:normal;
          -webkit-animation-direction:normal;
          -moz-animation-direction:normal;
          border-radius:5px;
          -o-border-radius:5px;
          -ms-border-radius:5px;
          -webkit-border-radius:5px;
          -moz-border-radius:5px;
        }

        #circleG_1{
          animation-delay:0.2695s;
          -o-animation-delay:0.2695s;
          -ms-animation-delay:0.2695s;
          -webkit-animation-delay:0.2695s;
          -moz-animation-delay:0.2695s;
        }

        #circleG_2{
          animation-delay:0.6355s;
          -o-animation-delay:0.6355s;
          -ms-animation-delay:0.6355s;
          -webkit-animation-delay:0.6355s;
          -moz-animation-delay:0.6355s;
        }

        #circleG_3{
          animation-delay:0.8185s;
          -o-animation-delay:0.8185s;
          -ms-animation-delay:0.8185s;
          -webkit-animation-delay:0.8185s;
          -moz-animation-delay:0.8185s;
        }

        @keyframes bounce_circleG{
          0%{}
          50%{
          background-color:rgb(100,149,237);
          }
          100%{}
        }

        @-o-keyframes bounce_circleG{
          0%{}
          50%{
          background-color:rgb(100,149,237);
          }
          100%{}
        }

        @-ms-keyframes bounce_circleG{
          0%{}
          50%{
          background-color:rgb(100,149,237);
          }
          100%{}
        }

        @-webkit-keyframes bounce_circleG{
          0%{}
          50%{
          background-color:rgb(100,149,237);
          }
          100%{}
        }

        @-moz-keyframes bounce_circleG{
          0%{}
          50%{
          background-color:rgb(100,149,237);
          }
          100%{}
        }


      </style>

      <script type="text/javascript">


        function getCookie(cname) {
          var name = cname + "=";
          var ca = document.cookie.split(';');
          for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              return c.substring(name.length,c.length);
            }
          }
          return "";
        }


        $(function() {


          var uiBasePath = "{{ .uiBasePath }}",
              apiListPath = "{{ .apiListPath }}",
              fieldsJSON = "{{ .fieldsJSON }}",
              table = $('table#item_list'),
              thead = $('<thead>'),
              tbody = $('<tbody>');


          var fields;
          if (fieldsJSON.length) {
            fields = JSON.parse(fieldsJSON);
          }


          // Table headers
          var headerTrHtml = '<tr>';
          headerTrHtml += "<th></th>"; // for checkbox
          headerTrHtml += '<th>ID</th>';

          // for (var fieldKey in fields) { // Attributes
          //   var fieldHeader = fields[fieldKey];
          //   headerTrHtml += '<th>' + fieldHeader + '</th>'
          // }

          $.each(fields, function(fx, field) {
            headerTrHtml += '<th>' + field.title + '</th>'
          });

          headerTrHtml += '<th>Status</th>';
          headerTrHtml += '</tr>';


          thead.append($(headerTrHtml))
          table.append(thead);
          table.append(tbody);


          // func
          function renderList() {
            $.ajax({
              url: apiListPath,
              beforeSend: function(xhr){
                xhr.setRequestHeader('Authorization', 'SGAPI session="' + getCookie('supergiant_session') + '"');
              },
              success: function(data) {
                items = JSON.parse(data);



                // Remove any non-updated items (assuming they're deleted)
                $('tr.item[data-old-item="true"]').remove();
                // Mark existing items as old
                $("tr.item").attr("data-old-item", "true");



                $.each(items, function(i, item) {

                  previousTr = $('tr#item_' + item.id);

                  // Gather field vals
                  var fieldVals = [];
                  $.each(fields, function(fx, field) {

                    var val;

                    if (field.type == "field_value") {
                      var keys = field.field.split(".");
                      val = item;
                      $.each(keys, function(kx, key) {
                        val = val[key];
                      })
                    } else if (field.type == "percentage") {

                      var numerator = item[field.numerator_field],
                          denominator = item[field.denominator_field],
                          percent = Math.round(numerator * 100 / denominator);

                      val = '<div class="progress" style="height: 10px; margin: 4px 0 0 0">' +
                            '<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="' + percent + '" aria-valuemin="0" aria-valuemax="100" style="width: ' + percent + '%">' +
                            '</div>' +
                            '</div>';
                    }

                    fieldVals.push(val);

                  });

                  // Build <tr> HTML
                  var trHtml = '<tr class="item" data-old-item="false" id="item_' + item.id + '">';

                  // Checkbox column (for batch actions)
                  // var disabledCheckbox = item.status ? " disabled" : "";
                  var disabledCheckbox = ""; // TODO we do need some type of disabling, but doing this prevents deleting hanging deploy
                  trHtml += '<td class="item_selector"><input type="checkbox" id="' + item.id + '"' + disabledCheckbox + '></td>';

                  // ID column
                  trHtml += '<td><a href="' + uiBasePath + '/' + item.id + '">' + item.id + '</a></td>';

                  // Attribute columns
                  $.each(fieldVals, function(vx, val) {
                    trHtml += '<td>' + val + '</td>';
                  });

                  // Status column
                  var statusTd = '<td';
                  if (item.status) {
                    var color = item.status.description == "deleting" ? "danger" : "info";
                    statusTd += ' class="text-' + color + '">';

                    statusTd += '<span>' + item.status.description + '</span>';

                    // Loader
                    statusTd += '<div id="circleG"><div id="circleG_1" class="circleG"></div><div id="circleG_2" class="circleG"></div><div id="circleG_3" class="circleG"></div></div>'

                    statusTd += '</td>'

                  } else {
                    statusTd += '></td>';
                  }
                  trHtml += statusTd;

                  trHtml += '</tr>';


                  var newTr = $(trHtml);

                  if (previousTr.length) {

                    // Don't replace (we don't want flashing) if it hasn't changed.
                    // However, do update this attribute so it's not deleted.
                    if (previousTr[0].innerHTML == newTr[0].innerHTML) {
                      previousTr.attr("data-old-item", "false")
                    } else {
                      // console.log("REPLACING");
                      previousTr.replaceWith(newTr);
                    }
                  } else {
                    // console.log("APPENDING")
                    tbody.append($(trHtml));
                  }

                });



              },
              error: function(data) {
                console.warn(data)

                // Session no longer exists, force login
                if (data.status == 401) {
                  location.reload()
                }
              }
            });
          }






          if (table.length) {
            renderList();
            setInterval(renderList, 1000);



            var actionLinks = $('a[data-action-path]'),
                batchActionLinks = $('a[data-batch-action-path]'),
                confirmModal = $('.modal#confirm_action'),
                modalBody = $('.model-body'),
                modalActionName = $("strong#modal_action_name"),
                modalList = $("ul#modal_list"),
                modalConfirmBtn = $('#confirm_action_btn'),
                selectedItemIDs = [];



            tbody.on("click", "td.item_selector", function(event) {
              var input = $(this).children('input'),
                  itemID = input[0].id;

              if (event.target.tagName == "INPUT") {
                // do its natural thing...
              } else {
                input.prop('checked', !input.prop('checked')) // toggle
              }

              selectedItemIDs = [];
              $("td.item_selector > input:checked").each(function(chx, checkbox) {
                selectedItemIDs.push(checkbox.id);
              });

              // if (input.prop('checked')) {
              //   selectedItemIDs[itemID] = true;
              // } else {
              //   delete selectedItemIDs[itemID];
              // }

              // Single actions
              if (selectedItemIDs.length == 1) {
                actionLinks.each(function(lx, actionLink) {
                  var link = $(actionLink),
                      path = uiBasePath + "/" + itemID + link.data("action-path");
                  link.attr("href", path);
                });
                actionLinks.removeAttr('disabled');
                actionLinks.removeClass('disabled');
              } else {
                actionLinks.attr("href", "#");
                actionLinks.attr('disabled', 'disabled');
                actionLinks.addClass('disabled');
              }

              // Batch actions
              if (selectedItemIDs.length > 0) {
                batchActionLinks.removeAttr('disabled');
                batchActionLinks.removeClass('disabled');
              } else {
                batchActionLinks.attr('disabled', 'disabled');
                batchActionLinks.addClass('disabled');
              }
            });


            // Display and render items in modal on action link click
            batchActionLinks.on('click', function() {
              var link = $(this);

              if (link.hasClass("disabled")) {
                return false;
              }

              var actionName = link.text();
              modalActionName.text(actionName);


              // TODO
              if (actionName == "Delete") {
                modalConfirmBtn.addClass("btn-danger");
                modalActionName.addClass("text-danger");
              } else {
                modalConfirmBtn.removeClass("btn-danger");
                modalActionName.removeClass("text-danger");
              }


              modalList.empty();
              $.each(selectedItemIDs, function(selx, id) {
                modalList.append($("<li>" + id + "</li>"));
              });

              modalConfirmBtn.text(actionName);
              modalConfirmBtn.data("batch-action-path", link.data("batch-action-path"));

              confirmModal.modal();

              return false;
            });


            // On action confirmation, iterate through items and make requests
            modalConfirmBtn.on('click', function() {
              // TODO
              var alerted = false;

              $.each(selectedItemIDs, function(selx, id) {

                console.log(uiBasePath + "/" + id + modalConfirmBtn.data("batch-action-path"))

                $.ajax({
                  type: "PUT",
                  beforeSend: function(xhr){
                    xhr.setRequestHeader('Authorization', 'SGAPI session="' + getCookie('supergiant_session') + '"');
                  },
                  url: uiBasePath + "/" + id + modalConfirmBtn.data("batch-action-path"),
                  error: function(data) {
                    if (!alerted) {
                      alert(data.responseText);
                    }
                    alerted = true;
                  }
                });
              });



              renderList();
              confirmModal.modal("hide");
            });


            // 1. on checkbox click
            //
            // 2. gather selected item IDs, and store globally
            //
            // 3. if empty, un-disable action links in drop down
            //
            // ----
            //
            // 1. on action link click
            //
            // 2. modal pops up, says action name with list of all selected items
            //
            // ----
            //
            // 1. on confirmation, iterate through all items and make action request
            //
            // 2. wait for response (since async) for every item
            //
            // 3. renderList()
            //
            // 4. close modal
          }




          var logDiv = $('#log');
          if (logDiv.length) {

            var renderLogs = function() {
              $.get({
                beforeSend: function(xhr){
                  xhr.setRequestHeader('Authorization', 'SGAPI session="' + getCookie('supergiant_session') + '"');
                },
                url: "/api/v0/log",
                success: function(data) {

                  data = data.replace(/[\x00-\x7F]\[\d+mINFO[\x00-\x7F]\[0m/g, "<span class='text-info'>INFO</span> ")
                  data = data.replace(/[\x00-\x7F]\[\d+mWARN[\x00-\x7F]\[0m/g, "<span class='text-warning'>WARN</span> ")
                  data = data.replace(/[\x00-\x7F]\[\d+mERRO[\x00-\x7F]\[0m/g, "<span class='text-danger'>ERRO</span> ")

                  logDiv.html(data);

                }
              });
            };

            renderLogs();

            // Scroll to bottom (like a terminal)
            logDiv.animate({
              scrollTop: logDiv.height()
            }, 1000);

            setInterval(renderLogs, 1000);
          }


        });
      </script>

    </head>
    <body>

      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <a class="navbar-brand" href="/ui">
              SUPERGIANT
            </a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          </div>

        </div><!-- /.container-fluid -->
      </nav>

      <div class="container-fluid" id="main">
        <div class="row" id="main">

          <div class="col-xs-2" id="sidenav">
            <div class="list-group">
              <a class='list-group-item{{ if eq .title "Sessions" }} active{{ end }}' href="/ui/sessions">Sessions</a>

              <a class='list-group-item{{ if eq .title "Users" }} active{{ end }}' href="/ui/users">Users</a>

              <a class='list-group-item{{ if eq .title "Cloud Accounts" }} active{{ end }}' href="/ui/cloud_accounts">Cloud Accounts</a>

              <a class='list-group-item{{ if eq .title "Private Image Keys" }} active{{ end }}' href="/ui/private_image_keys">Private Image Keys</a>

              <a class='list-group-item{{ if eq .title "Kubes" }} active{{ end }}' href="/ui/kubes">Kubes</a>

              <a class='list-group-item{{ if eq .title "Nodes" }} active{{ end }}' href="/ui/nodes">Nodes</a>

              <a class='list-group-item{{ if eq .title "Apps" }} active{{ end }}' href="/ui/apps">Apps</a>

              <a class='list-group-item{{ if eq .title "Components" }} active{{ end }}' href="/ui/components">Components</a>

              <a class='list-group-item{{ if eq .title "Entrypoints" }} active{{ end }}' href="/ui/entrypoints">Entrypoints</a>

              <a class='list-group-item{{ if eq .title "Instances" }} active{{ end }}' href="/ui/instances">Instances</a>

              <a class='list-group-item{{ if eq .title "Volumes" }} active{{ end }}' href="/ui/volumes">Volumes</a>
            </div>
          </div>

          <div class="col-xs-10" id="content">
            {{ template "body" . }}
          </div>

        </div>
      </div>

    </body>
  </html>
{{ end }}

// We define empty blocks for optional content so we don't have to define a block in child templates that don't need them
{{ define "not_required_stuff" }}{{ end }}
